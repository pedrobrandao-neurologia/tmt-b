<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trail Making Test B (TMT-B) ‚Äî Vers√£o Aprimorada</title>
<meta name="description" content="Implementa√ß√£o digital do TMT-B para avalia√ß√£o de flexibilidade cognitiva e aten√ß√£o alternada, com registro completo e exporta√ß√£o de dados."/>
<meta name="author" content="Laborat√≥rio de Neuroci√™ncia Cognitiva"/>
<meta name="version" content="3.2.0"/>

<style>
:root{
  --primary:#673AB7; --primary-dark:#512DA8;
  --success:#4CAF50; --error:#f44336; --warning:#FF9800; --info:#00BCD4;
  --num-bg:#E3F2FD; --let-bg:#F1F8E9; --num-bd:#2196F3; --let-bd:#8BC34A;
  --bg0:#f4f6f9; --bg1:#e9ecf1; --text:#212121; --muted:#666; --line:#e0e0e0;
  --r:12px; --shadow-sm:0 2px 4px rgba(0,0,0,.1); --shadow-md:0 4px 8px rgba(0,0,0,.15); --shadow-lg:0 8px 16px rgba(0,0,0,.2);
  --circle:52px; --minDist:84px; --t:.25s;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,system-ui,sans-serif;
  background:linear-gradient(135deg,var(--bg0),var(--bg1));
  color:var(--text); display:flex; align-items:center; justify-content:center; padding:1rem;
}
.container{width:100%;max-width:1200px;background:#fff;border-radius:var(--r);box-shadow:var(--shadow-lg);overflow:hidden}
.header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;text-align:center;padding:2rem}
.header h1{font-weight:700;font-size:2rem;text-shadow:0 2px 4px rgba(0,0,0,.25)}
.header p{opacity:.95;margin-top:.25rem}
.main{padding:1.5rem}
.phase{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin-bottom:1.25rem}
.dot{width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;color:var(--muted);font-weight:700;position:relative;transition:transform var(--t),background var(--t),color var(--t)}
.dot::after{content:attr(data-label);position:absolute;bottom:-20px;font-size:.72rem;color:var(--muted);white-space:nowrap}
.dot.active{background:var(--primary);color:#fff;transform:scale(1.06);box-shadow:0 0 0 4px rgba(103,58,183,.2)}
.dot.done{background:var(--success);color:#fff}
.instructions{
  background:linear-gradient(135deg,rgba(103,58,183,.06),rgba(103,58,183,.025));
  border-left:4px solid var(--primary);border-radius:8px;padding:1rem;line-height:1.6;margin:1rem 0 1.25rem
}
.instructions h3{color:var(--primary);margin-bottom:.5rem}
.progress{height:8px;border-radius:4px;background:var(--line);overflow:hidden}
.progress .fill{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--success));transition:width .3s}
.stage{
  margin:1rem auto 0; width:100%;max-width:900px;height:520px;border:3px solid var(--line);border-radius:var(--r);
  position:relative;background:#fafafa;box-shadow:inset 0 2px 8px rgba(0,0,0,.05);touch-action:manipulation;
}
.countdown{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:8rem;color:var(--primary);
  background:rgba(255,255,255,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:50
}
.node{
  position:absolute;width:var(--circle);height:var(--circle);border-radius:999px;border:3px solid;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:1.15rem;cursor:pointer;user-select:none;box-shadow:var(--shadow-sm);transition:transform var(--t),box-shadow var(--t),background var(--t),color var(--t),border-color var(--t);
}
.node.number{background:var(--num-bg);border-color:var(--num-bd);color:var(--num-bd)}
.node.letter{background:var(--let-bg);border-color:var(--let-bd);color:var(--let-bd)}
.node:hover,.node:focus{outline:0;transform:scale(1.12);box-shadow:var(--shadow-md)}
.node.target{animation:pulse 1.4s infinite}
.node.correct{background:var(--success)!important;color:#fff!important;border-color:var(--success)!important;transform:scale(.96);pointer-events:none}
.node.err{animation:shake .4s;border-color:var(--error)!important}
.line{position:absolute;height:3px;background:var(--success);transform-origin:left center;z-index:5;pointer-events:none}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-7px)}75%{transform:translateX(7px)}}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem;margin:1rem 0}
.card{background:linear-gradient(135deg,#f7f7f7,#fff);border:1px solid var(--line);border-radius:var(--r);padding:1rem;text-align:center;transition:transform var(--t),box-shadow var(--t)}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.val{font-weight:800;font-size:1.6rem;color:var(--primary)}
.lab{font-size:.8rem;color:var(--muted);letter-spacing:.04em;text-transform:uppercase;margin-top:.15rem}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin:1rem 0}
.btn{
  min-width:160px;padding:.75rem 1.25rem;border-radius:10px;border:2px solid transparent;font-weight:800;letter-spacing:.02em;cursor:pointer;
  transition:transform var(--t),box-shadow var(--t),background var(--t),color var(--t),border var(--t)
}
.btn:focus-visible{outline:3px solid #000;outline-offset:2px}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
.btn-primary:hover:not([disabled]){transform:translateY(-2px);box-shadow:var(--shadow-md)}
.btn-sec{background:#fff;color:var(--primary);border-color:var(--primary)}
.btn-sec:hover:not([disabled]){background:var(--primary);color:#fff}
.msg{margin:.75rem 0;padding:.75rem;border-radius:8px;text-align:center;font-weight:600}
.msg.info{background:rgba(0,188,212,.1);color:var(--info);border:1px solid rgba(0,188,212,.3)}
.msg.ok{background:rgba(76,175,80,.1);color:var(--success);border:1px solid rgba(76,175,80,.3)}
.msg.warn{background:rgba(255,152,0,.12);color:var(--warning);border:1px solid rgba(255,152,0,.3)}
.msg.err{background:rgba(244,67,54,.12);color:var(--error);border:1px solid rgba(244,67,54,.3)}
/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex;animation:fade .25s}
@keyframes fade{from{opacity:0}to{opacity:1}}
.sheet{background:#fff;border-radius:14px;max-width:960px;width:92%;max-height:92vh;overflow:auto;box-shadow:var(--shadow-lg);padding:1.25rem}
.sheet header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border-bottom:2px solid var(--line);padding-bottom:.75rem;margin-bottom:.75rem}
.sheet h2{color:var(--primary)}
.close{background:none;border:0;font-size:1.6rem;cursor:pointer;color:var(--muted)}
.section{background:#fafafa;border:1px solid var(--line);border-radius:10px;padding:1rem;margin:.75rem 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:.5rem}
.item{background:#fff;border:1px solid var(--line);border-radius:8px;padding:.75rem}
.item .lab{margin:0;color:var(--muted)}
.item .val{font-size:1.2rem;color:var(--primary)}
.export{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:.5rem}
kbd{background:#eee;border-radius:6px;border:1px solid #ddd;padding:.1rem .35rem}
.test-on .stats,.test-on .progress{opacity:.2}
@media (max-width:768px){
  :root{--circle:46px;--minDist:72px}
  .header h1{font-size:1.55rem}
  .stage{height:440px}
}
</style>
</head>
<body>
<div class="container" id="root">
  <header class="header">
    <h1>Teste de Trilhas ‚Äî Parte B (TMT-B)</h1>
    <p>Avalia√ß√£o de aten√ß√£o alternada e flexibilidade cognitiva</p>
  </header>

  <main class="main">
    <div class="phase" aria-hidden="true">
      <div class="dot" id="p1" data-label="Instru√ß√µes">1</div>
      <div class="dot" id="p2" data-label="Aquecimento">2</div>
      <div class="dot" id="p3" data-label="Teste">3</div>
      <div class="dot" id="p4" data-label="Resultados">4</div>
    </div>

    <div class="instructions" id="instructions">
      <h3>üìã Como executar</h3>
      <p>Toque/clique alternando <strong>n√∫meros</strong> e <strong>letras</strong> em ordem crescente: <strong>1 ‚Üí A ‚Üí 2 ‚Üí B ‚Üí 3 ‚Üí C</strong> ‚Ä¶ at√© <strong>13 ‚Üí L</strong>.
      Fa√ßa o mais r√°pido poss√≠vel e sem erros. Em caso de erro, <em>o tempo continua</em> e ser√° necess√°rio selecionar o item correto para avan√ßar.</p>
      <p style="margin-top:.5rem">Recomenda-se ambiente silencioso, tela em modo paisagem (se poss√≠vel) e uma tentativa de treino antes do teste principal.</p>
    </div>

    <div class="progress" aria-hidden="true"><div class="fill" id="progress"></div></div>
    <div class="stage" id="stage" role="application" aria-label="√Årea do teste TMT-B"></div>

    <section class="stats" aria-hidden="true">
      <div class="card"><div class="val" id="timer">00:00</div><div class="lab">Tempo</div></div>
      <div class="card"><div class="val" id="next">1</div><div class="lab">Pr√≥ximo</div></div>
      <div class="card"><div class="val" id="errs">0</div><div class="lab">Erros</div></div>
      <div class="card"><div class="val" id="switch">‚Äì</div><div class="lab">Custo de altern√¢ncia</div></div>
    </section>

    <div class="msg info" id="msg" role="status" aria-live="polite">
      Bem-vindo! Inicie pelo <strong>Aquecimento</strong>.
    </div>

    <div class="controls">
      <button class="btn btn-sec" id="btnPractice" aria-label="Come√ßar aquecimento">Come√ßar Aquecimento</button>
      <button class="btn btn-primary" id="btnStart" aria-label="Come√ßar teste principal" disabled>Come√ßar Teste Principal</button>
      <button class="btn btn-sec" id="btnResults" aria-label="Ver resultados" style="display:none">Ver Resultados</button>
      <button class="btn btn-sec" id="btnReset" aria-label="Reiniciar">Reiniciar</button>
    </div>
  </main>
</div>

<!-- Modal de resultados -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="ttl">
    <header>
      <h2 id="ttl">üìä Relat√≥rio de Resultados ‚Äî TMT-B</h2>
      <button class="close" id="closeModal" aria-label="Fechar resultados">√ó</button>
    </header>

    <div class="section">
      <h3>Desempenho geral</h3>
      <div class="grid">
        <div class="item"><div class="lab">Tempo total</div><div class="val" id="r-time">‚Äì</div></div>
        <div class="item"><div class="lab">Total de erros</div><div class="val" id="r-err">‚Äì</div></div>
        <div class="item"><div class="lab">Precis√£o</div><div class="val" id="r-acc">‚Äì</div></div>
        <div class="item"><div class="lab">Classifica√ß√£o*</div><div class="val" id="r-class">‚Äì</div></div>
      </div>
      <small>*Heur√≠stica para feedback imediato; n√£o substitui normas estratificadas.</small>
    </div>

    <div class="section">
      <h3>Flexibilidade cognitiva</h3>
      <div class="grid">
        <div class="item"><div class="lab">Custo de altern√¢ncia</div><div class="val" id="r-switch">‚Äì</div></div>
        <div class="item"><div class="lab">Tempo m√©dio (switch)</div><div class="val" id="r-avg-sw">‚Äì</div></div>
        <div class="item"><div class="lab">Tempo m√©dio (n√£o-switch)</div><div class="val" id="r-avg-nsw">‚Äì</div></div>
        <div class="item"><div class="lab">Efici√™ncia espacial</div><div class="val" id="r-eff">‚Äì</div></div>
      </div>
    </div>

    <div class="section">
      <h3>An√°lise de erros</h3>
      <div class="grid">
        <div class="item"><div class="lab">Erros de categoria</div><div class="val" id="r-e-cat">‚Äì</div></div>
        <div class="item"><div class="lab">Erros de sequ√™ncia</div><div class="val" id="r-e-seq">‚Äì</div></div>
        <div class="item"><div class="lab">Erros de regress√£o</div><div class="val" id="r-e-reg">‚Äì</div></div>
        <div class="item"><div class="lab">√çndice de persevera√ß√£o</div><div class="val" id="r-perc">‚Äì</div></div>
      </div>
    </div>

    <div class="export">
      <button class="btn btn-primary" id="btnCSV">üì• Exportar resumo (CSV)</button>
      <button class="btn btn-primary" id="btnJSON">üì• Exportar JSON</button>
      <button class="btn btn-primary" id="btnLOG">üì• Exportar LOG bruto (CSV)</button>
    </div>
  </div>
</div>

<script>
/* ===== Utilidades ===== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

/* RNG com semente (Mulberry32) para reprodutibilidade */
function seededRand(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ t>>>15, 1 | t);
    r ^= r + Math.imul(r ^ r>>>7, 61 | r);
    return ((r ^ r>>>14) >>> 0) / 4294967296;
  };
}
function getSeed(){
  const u = new URL(String(window.location));
  const s = u.searchParams.get("seed") || (u.hash||"").replace("#","").split("=")[1];
  return isNaN(+s) ? null : +s;
}

/* ===== Teste TMT-B ===== */
class TMTB {
  constructor(){
    this.cfg = {
      PRACTICE_PAIRS: 4,     // 1-A a 4-D
      FULL_PAIRS: 12,        // 1-A a 12-L + 13
      MAX_TIME_MS: 5*60*1000,
      MIN_DIST: null,        // definido via CSS em px
      MARGIN: 52,            // margem interna da √°rea
      COUNTDOWN: 3
    };
    this.el = this.bindElements();
    this.bindUI();
    this.reset(true);
  }

  bindElements(){
    return {
      root: qs('#root'),
      stage: qs('#stage'),
      msg: qs('#msg'),
      timer: qs('#timer'),
      next: qs('#next'),
      errs: qs('#errs'),
      switch: qs('#switch'),
      fill: qs('#progress'),
      btnPractice: qs('#btnPractice'),
      btnStart: qs('#btnStart'),
      btnReset: qs('#btnReset'),
      btnResults: qs('#btnResults'),
      dots: {1:qs('#p1'),2:qs('#p2'),3:qs('#p3'),4:qs('#p4')},
      modal: qs('#modal'), closeModal: qs('#closeModal'),
      r:{time:qs('#r-time'), err:qs('#r-err'), acc:qs('#r-acc'), cls:qs('#r-class'),
         sw:qs('#r-switch'), asw:qs('#r-avg-sw'), answ:qs('#r-avg-nsw'), eff:qs('#r-eff'),
         ecat:qs('#r-e-cat'), eseq:qs('#r-e-seq'), ereg:qs('#r-e-reg'), perc:qs('#r-perc')},
      btnCSV: qs('#btnCSV'), btnJSON: qs('#btnJSON'), btnLOG: qs('#btnLOG')
    };
  }

  bindUI(){
    this.el.btnPractice.addEventListener('click', ()=>this.startPractice());
    this.el.btnStart.addEventListener('click', ()=>this.startTest());
    this.el.btnReset.addEventListener('click', ()=>this.reset(true));
    this.el.btnResults.addEventListener('click', ()=>this.showResults());
    this.el.closeModal.addEventListener('click', ()=>this.hideResults());
    this.el.btnCSV.addEventListener('click', ()=>this.exportCSV());
    this.el.btnJSON.addEventListener('click', ()=>this.exportJSON());
    this.el.btnLOG.addEventListener('click', ()=>this.exportLogCSV());
    // evitar espa√ßo rolar p√°gina durante teste
    window.addEventListener('keydown', e=>{
      if(this.state?.isRunning && (e.key===' '||e.key==='Spacebar')) e.preventDefault();
    });
    // foco vis√≠vel nos n√≥s via teclado
    this.el.stage.addEventListener('keydown', e=>{
      if(!this.state?.isRunning) return;
      // sem navega√ß√£o por teclado para prevenir ‚Äúatalhos‚Äù ‚Äî apenas clique/toque
      if(['Enter',' '].includes(e.key)) e.preventDefault();
    });
  }

  reset(full=true){
    this.stopTimer();
    this.el.root.classList.remove('test-on');
    this.clearStage();
    this.seqFull = this.makeSequence(this.cfg.FULL_PAIRS);
    this.seqPractice = this.makeSequence(this.cfg.PRACTICE_PAIRS);
    const style = getComputedStyle(document.documentElement);
    this.cfg.MIN_DIST = parseFloat(style.getPropertyValue('--minDist')) || 80;

    this.state = {
      phase:'instructions', isPractice:false, isRunning:false,
      seq:[], current:0, start:0, end:0,
      nodes:[], pos:[], clicks:[], errors:[], totalDist:0, optimalDist:0,
      seed: getSeed(), rng: null
    };
    this.state.rng = this.state.seed!=null ? seededRand(this.state.seed) : Math.random;

    if(full){
      this.setPhase(1);
      this.uiSet(this.el.timer,'00:00');
      this.uiSet(this.el.next,'1');
      this.uiSet(this.el.errs,'0');
      this.uiSet(this.el.switch,'‚Äì');
      this.el.fill.style.width='0%';
      this.message('Bem-vindo! Clique em ‚ÄúCome√ßar Aquecimento‚Äù para praticar.','info');
      this.el.btnPractice.disabled=false;
      this.el.btnStart.disabled=true;
      this.el.btnStart.style.display='inline-block';
      this.el.btnPractice.style.display='inline-block';
      this.el.btnResults.style.display='none';
    }
  }

  setPhase(n){
    Object.values(this.el.dots).forEach(d=>d.classList.remove('active','done'));
    for(let i=1;i<n;i++) this.el.dots[i].classList.add('done');
    this.el.dots[n].classList.add('active');
  }

  makeSequence(pairs){
    const seq=[];
    for(let i=1;i<=pairs;i++){
      seq.push({v:String(i), t:'number'});
      seq.push({v:String.fromCharCode(64+i), t:'letter'}); // A=65
    }
    if(pairs===this.cfg.FULL_PAIRS) seq.push({v:String(pairs+1), t:'number'}); // final 13
    return seq;
  }

  startPractice(){
    this.setPhase(2);
    this.state.isPractice = true;
    this.state.phase='practice';
    this.state.seq = this.seqPractice;
    this.el.btnPractice.disabled=true;
    this.el.btnStart.disabled=true;
    this.message('Aquecimento: prepare-se‚Ä¶','info');
    this.placeNodes();
    this.countdown(()=>{ this.startTimer(); this.el.root.classList.add('test-on'); });
  }

  startTest(){
    this.setPhase(3);
    this.reset(false);
    this.state.isPractice = false;
    this.state.phase='test';
    this.state.seq = this.seqFull;
    this.el.btnStart.style.display='none';
    this.message('Teste principal: prepare-se‚Ä¶','info');
    this.placeNodes();
    this.countdown(()=>{ this.startTimer(); this.el.root.classList.add('test-on'); });
  }

  countdown(cb){
    const overlay = document.createElement('div');
    overlay.className='countdown';
    let n=this.cfg.COUNTDOWN;
    overlay.textContent=n;
    this.el.stage.appendChild(overlay);
    const iv=setInterval(()=>{
      n--;
      if(n>0) overlay.textContent=n;
      else if(n===0) overlay.textContent='J√Å!';
      else{ clearInterval(iv); overlay.remove(); cb(); }
    },1000);
  }

  placeNodes(){
    this.clearStage();
    this.state.nodes=[]; this.state.pos=[]; this.state.current=0; this.state.totalDist=0;
    const r = this.el.stage.getBoundingClientRect();
    const W=r.width, H=r.height, M=this.cfg.MARGIN, MIN=this.cfg.MIN_DIST;
    let triesGlobal=0;

    const rand = ()=> this.state.rng();

    for(const item of this.state.seq){
      let attempts=0, x=0,y=0, ok=false, min=MIN;
      while(attempts<180){
        x = M + rand()*(W-2*M);
        y = M + rand()*(H-2*M);
        if(this.state.pos.every(p => Math.hypot(x-p.x, y-p.y) >= min)){ ok=true; break; }
        attempts++;
        if(attempts%60===0) min = Math.max(48, min-6); // recuo adaptativo para garantir aloca√ß√£o
      }
      if(!ok){ // falha rara: recome√ßa distribui√ß√£o
        if(++triesGlobal>3){ console.warn('Distribui√ß√£o dif√≠cil ‚Äî reduzindo dist√¢ncia m√≠nima.'); }
        return this.placeNodes();
      }
      this.state.pos.push({x,y,item});
      const node = this.makeNode({x,y,item});
      this.el.stage.appendChild(node);
      this.state.nodes.push({node,item});
    }
    this.computeOptimalDistance();
    this.highlightTarget();
  }

  makeNode({x,y,item}){
    const d = document.createElement('div');
    d.className = `node ${item.t}`;
    d.tabIndex = 0;
    d.textContent = item.v;
    const R = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--circle'))||52;
    d.style.left = `${x - R/2}px`;
    d.style.top  = `${y - R/2}px`;
    d.setAttribute('role','button');
    d.setAttribute('aria-label', (item.t==='number'?'N√∫mero ':'Letra ') + item.v);
    d.addEventListener('pointerdown', (e)=>{ e.preventDefault(); this.onClick(item,d); }, {passive:false});
    d.addEventListener('click', (e)=>{ e.preventDefault(); }); // padroniza para pointer
    return d;
  }

  onClick(item,node){
    if(!this.state.isRunning) return;
    const now = performance.now();
    const expected = this.state.seq[this.state.current];
    const correct = (item.v===expected.v && item.t===expected.t);
    this.state.clicks.push({ts:now, item, expected, correct});

    if(correct){
      node.classList.add('correct');
      if(this.state.current>0){
        this.drawLine(this.state.current-1, this.state.current);
        this.addDistance(this.state.current-1, this.state.current);
      }
      this.state.current++;
      if(this.state.current>=this.state.seq.length){ this.finish(false); }
      else { this.highlightTarget(); this.updateProgress(); this.updateSwitchCostHUD(); }
    }else{
      node.classList.add('err');
      setTimeout(()=>node.classList.remove('err'), 380);
      this.state.errors.push({ts:now, clicked:item, expected});
      this.uiSet(this.el.errs, String(this.state.errors.length));
      this.message(`Aten√ß√£o: selecione ${expected.v}.`, 'warn');
    }
  }

  drawLine(i,j){
    const a=this.state.pos[i], b=this.state.pos[j];
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist=Math.hypot(dx,dy), ang=Math.atan2(dy,dx)*180/Math.PI;
    const line=document.createElement('div');
    line.className='line';
    line.style.width=`${dist}px`;
    line.style.left=`${a.x}px`;
    line.style.top =`${a.y}px`;
    line.style.transform=`rotate(${ang}deg)`;
    this.el.stage.appendChild(line);
  }
  addDistance(i,j){
    const a=this.state.pos[i], b=this.state.pos[j];
    this.state.totalDist += Math.hypot(b.x-a.x, b.y-a.y);
  }
  computeOptimalDistance(){
    this.state.optimalDist=0;
    for(let i=1;i<this.state.pos.length;i++){
      const a=this.state.pos[i-1], b=this.state.pos[i];
      this.state.optimalDist += Math.hypot(b.x-a.x, b.y-a.y);
    }
  }

  highlightTarget(){
    this.state.nodes.forEach(n=>n.node.classList.remove('target'));
    if(this.state.current < this.state.seq.length){
      const tgt = this.state.nodes[this.state.current];
      if(tgt) tgt.node.classList.add('target');
      this.uiSet(this.el.next, this.state.seq[this.state.current].v);
    }
  }

  updateProgress(){
    const p = (this.state.current / this.state.seq.length)*100;
    this.el.fill.style.width = `${p}%`;
  }

  startTimer(){
    this.state.isRunning=true;
    this.state.start = performance.now();
    this.tIV = setInterval(()=>{
      const elapsed = performance.now() - this.state.start;
      if(elapsed>=this.cfg.MAX_TIME_MS){ this.finish(true); return; }
      const mm = Math.floor(elapsed/60000);
      const ss = Math.floor((elapsed%60000)/1000);
      this.uiSet(this.el.timer, `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`);
    }, 100);
  }
  stopTimer(){ if(this.tIV) clearInterval(this.tIV); this.state.isRunning=false; }

  finish(timeout){
    this.stopTimer();
    this.state.end = performance.now();
    this.state.phase='completed';
    this.el.root.classList.remove('test-on');

    if(this.state.isPractice){
      this.message('Aquecimento conclu√≠do! Quando pronto, inicie o teste principal.','ok');
      this.el.btnStart.disabled=false;
      this.setPhase(2);
    }else{
      this.setPhase(4);
      this.computeResults();
      this.message(timeout ? 'Tempo esgotado. Resultados dispon√≠veis.' : 'Teste conclu√≠do. Resultados dispon√≠veis.', timeout?'warn':'ok');
      this.el.btnResults.style.display='inline-block';
      this.showResults();
    }
  }

  computeResults(){
    const total = (this.state.end - this.state.start);
    const correctClicks = this.state.clicks.filter(c=>c.correct);
    const times = [];
    for(let i=1;i<correctClicks.length;i++){
      times.push(correctClicks[i].ts - correctClicks[i-1].ts);
    }
    const sw=[], nsw=[];
    for(let i=1;i<correctClicks.length;i++){
      const prev=correctClicks[i-1], cur=correctClicks[i];
      (cur.item.t!==prev.item.t ? sw : nsw).push(cur.ts - prev.ts);
    }
    const avg = arr => arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const avgSw=avg(sw), avgNsw=avg(nsw);
    const switchCost = (avgSw>0 && avgNsw>0)? (avgSw - avgNsw) : 0;
    const accuracy = this.state.clicks.length? (correctClicks.length/this.state.clicks.length)*100 : 0;
    const efficiency = this.state.totalDist>0? (this.state.optimalDist/this.state.totalDist)*100 : 0;

    // erros tipificados
    const E={category:0, sequence:0, regression:0};
    for(const e of this.state.errors){
      if(e.clicked.t !== e.expected.t) E.category++;
      else{
        const toNum = it => (it.t==='number')? parseInt(it.v,10) : (it.v.charCodeAt(0)-64);
        const clk=toNum(e.clicked), exp=toNum(e.expected);
        if(clk < exp) E.regression++; else E.sequence++;
      }
    }
    const perseveration = this.state.errors.length? (E.regression/this.state.errors.length)*100 : 0;

    // classifica√ß√£o heur√≠stica (ajuste conforme normas locais)
    const tSec = total/1000;
    let cls = "Superior";
    if(tSec>36) cls="M√©dio";
    if(tSec>78) cls="M√©dio Baixo";
    if(tSec>90 || this.state.errors.length>5) cls="Lim√≠trofe";
    if(tSec>290 || this.state.errors.length>15) cls="Comprometido";

    this.results = {
      totalTimeMs: Math.round(total),
      totalErrors: this.state.errors.length,
      accuracyPct: accuracy,
      switchCostMs: switchCost,
      avgSwitchMs: avgSw,
      avgNonSwitchMs: avgNsw,
      spatialEfficiencyPct: efficiency,
      errorTypes: E,
      perseverationPct: perseveration,
      classification: cls,
      meta: this.makeMeta()
    };
  }

  makeMeta(){
    const d = new Date();
    return {
      isoDate: d.toISOString(),
      version: document.querySelector('meta[name="version"]')?.content || 'NA',
      practice: this.state.isPractice,
      seed: this.state.seed ?? null,
      devicePixelRatio: window.devicePixelRatio||1,
      ua: navigator.userAgent,
      screen: {w:window.innerWidth,h:window.innerHeight}
    };
  }

  /* ===== UI helpers ===== */
  message(txt, kind='info'){ this.el.msg.textContent=txt; this.el.msg.className=`msg ${kind}`; }
  uiSet(el,txt){ el.textContent = txt; }
  clearStage(){ this.el.stage.innerHTML=''; }

  updateSwitchCostHUD(){
    const clicks = this.state.clicks.filter(c=>c.correct);
    if(clicks.length<2){ this.uiSet(this.el.switch,'‚Äì'); return; }
    let sw=[],nsw=[];
    for(let i=1;i<clicks.length;i++){
      const dt = clicks[i].ts - clicks[i-1].ts;
      (clicks[i].item.t!==clicks[i-1].item.t ? sw : nsw).push(dt);
    }
    if(sw.length && nsw.length){
      const m = Math.round(sw.reduce((a,b)=>a+b,0)/sw.length - nsw.reduce((a,b)=>a+b,0)/nsw.length);
      this.uiSet(this.el.switch, `${m} ms`);
    }
  }

  /* ===== Resultados/Exporta√ß√£o ===== */
  showResults(){
    if(!this.results){ this.message('Resultados ainda n√£o dispon√≠veis.','warn'); return; }
    const r=this.results;
    this.uiSet(this.el.r.time, `${(r.totalTimeMs/1000).toFixed(2)} s`);
    this.uiSet(this.el.r.err, String(r.totalErrors));
    this.uiSet(this.el.r.acc, `${r.accuracyPct.toFixed(1)}%`);
    this.uiSet(this.el.r.cls, r.classification);
    this.uiSet(this.el.r.sw, `${Math.round(r.switchCostMs)} ms`);
    this.uiSet(this.el.r.asw, `${Math.round(r.avgSwitchMs)} ms`);
    this.uiSet(this.el.r.answ, `${Math.round(r.avgNonSwitchMs)} ms`);
    this.uiSet(this.el.r.eff, `${r.spatialEfficiencyPct.toFixed(1)}%`);
    this.uiSet(this.el.r.ecat, String(r.errorTypes.category));
    this.uiSet(this.el.r.eseq, String(r.errorTypes.sequence));
    this.uiSet(this.el.r.ereg, String(r.errorTypes.regression));
    this.uiSet(this.el.r.perc, `${r.perseverationPct.toFixed(1)}%`);
    qs('#modal').classList.add('show');
  }
  hideResults(){ qs('#modal').classList.remove('show'); }

  exportJSON(){
    if(!this.results) return;
    const payload = {
      metadata:this.results.meta,
      summary:{
        totalTimeMs:this.results.totalTimeMs,
        totalErrors:this.results.totalErrors,
        accuracyPct:this.results.accuracyPct,
        classification:this.results.classification,
        switchCostMs:this.results.switchCostMs,
        avgSwitchMs:this.results.avgSwitchMs,
        avgNonSwitchMs:this.results.avgNonSwitchMs,
        spatialEfficiencyPct:this.results.spatialEfficiencyPct,
        errorTypes:this.results.errorTypes,
        perseverationPct:this.results.perseverationPct
      },
      clicks:this.state.clicks.map(c=>({
        ts:Math.round(c.ts - this.state.start),
        item:`${c.item.v}-${c.item.t}`,
        expected:`${c.expected.v}-${c.expected.t}`,
        correct:c.correct?1:0
      })),
      positions:this.state.pos.map((p,i)=>({index:i+1,x:Math.round(p.x),y:Math.round(p.y),label:`${p.item.v}-${p.item.t}`}))
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    this.download(blob, `TMTB_${Date.now()}.json`);
  }

  exportCSV(){
    if(!this.results) return;
    const r=this.results;
    const lines = [
      'M√©trica,Valor',
      `Tempo_total_ms,${r.totalTimeMs}`,
      `Erros_totais,${r.totalErrors}`,
      `Precisao_pct,${r.accuracyPct.toFixed(3)}`,
      `Classificacao,${r.classification}`,
      `Custo_alternancia_ms,${Math.round(r.switchCostMs)}`,
      `Tempo_medio_switch_ms,${Math.round(r.avgSwitchMs)}`,
      `Tempo_medio_nao_switch_ms,${Math.round(r.avgNonSwitchMs)}`,
      `Eficiencia_espacial_pct,${r.spatialEfficiencyPct.toFixed(3)}`,
      `Erros_categoria,${r.errorTypes.category}`,
      `Erros_sequencia,${r.errorTypes.sequence}`,
      `Erros_regressao,${r.errorTypes.regression}`,
      `Indice_perseveracao_pct,${r.perseverationPct.toFixed(3)}`,
      `Pratica,${this.state.isPractice?1:0}`,
      `Seed,${this.state.seed??''}`,
      `Versao,${document.querySelector('meta[name="version"]')?.content||''}`
    ];
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    this.download(blob, `TMTB_summary_${Date.now()}.csv`);
  }

  exportLogCSV(){
    const hdr = 't_ms,item,expected,correct\n';
    const rows = this.state.clicks.map(c=>{
      const t = Math.round(c.ts - this.state.start);
      return `${t},${c.item.v}-${c.item.t},${c.expected.v}-${c.expected.t},${c.correct?1:0}`;
    });
    const blob = new Blob([hdr+rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    this.download(blob, `TMTB_log_${Date.now()}.csv`);
  }

  download(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
}

/* ===== Inicializa√ß√£o ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const app = new TMTB();

  // acessibilidade: fechar modal com ESC
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ app.hideResults(); }
  });

  // dicas visuais de foco
  qsa('.btn').forEach(b=>b.addEventListener('keydown',e=>{
    if(e.key==='Enter'||e.key===' ') e.preventDefault();
  }));
});
</script>
</body>
</html>
